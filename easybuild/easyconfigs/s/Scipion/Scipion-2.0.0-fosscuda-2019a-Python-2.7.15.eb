easyblock = 'PythonBundle'

name = 'Scipion'
version = '2.0.0'
versionsuffix = '-Python-%(pyver)s'

homepage = 'https://github.com/I2PC/scipion/wiki'
description = """Scipion is an image processing framework to obtain 3D
models of macromolecular complexes using Electron Microscopy (3DEM). It
integrates several software packages and presents an unified interface
for both biologists and developers. Scipion allows to execute workflows
combining different software tools, while taking care of formats and
conversions. Additionally, all steps are tracked and can be reproduced
later on. 
"""

toolchain = {'name': 'fosscuda', 'version': '2019a'}

dependencies = [
    ('Python', '2.7.15'),
    ('Tcl', '8.6.9'),
    ('Tk', '8.6.9'),
    ('zlib', '1.2.11'),
    ('Java', '11', '', True),
    ('libxml2', '2.9.8'),
    ('libreadline', '8.0'),
    ('libxslt', '1.1.33'),
    ('GSL', '2.5'),
    ('freetype', '2.9.1'),
    ('Xmipp', '3.19.04-Apollo', versionsuffix),
    ('OpenCV', '3.4.7', versionsuffix),
    ('libpng', '1.6.36'),
    ('libjpeg-turbo', '2.0.2'),
    ('LibTIFF', '4.0.10'),
    ('SQLite', '3.27.2'),
    ('HDF5', '1.10.5'),

    # Python modules
    ('matplotlib', '2.2.4', versionsuffix),
    ('Biopython', '1.73'),
    ('bibtexparser', '1.1.0'),
    ('Pillow', '6.0.0'),

    # EM packages
    ('ctffind', '4.1.13'),
    ('RELION', '3.0.7'),
    ('EMAN2', '2.3', versionsuffix),
    ('MotionCor2', '1.2.6'),
    ('Gctf', '1.06', '', True),
]

use_pip = True

exts_default_options = {'source_urls': [PYPI_SOURCE]}

# scipion-em-xxx plugins are python modules
exts_list = [
    ('poster', '0.8.1', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['af5bf45da4a916db2b638cffd9e9d6668b33020e2b8ca9f864db79b49331c6ff'],
    }),
    ('Django', '1.5.5', {
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['6ae69c1dfbfc9d0c44ae80e2fbe48e59bbbbb70e8df66ad2b7029bd39947d71d'],
    }),
    (name, version, {
        'modulename': False,
        'patches': [
            '%(name)s-%(version)s_use_mpi_java_from_EB.patch',
            '%(name)s-%(version)s_ignore_path_check_when_doing_config.patch',
            '%(name)s-%(version)s_drop_packages_from_user_config.patch',
            '%(name)s-%(version)s_skip_notify_question.patch',
            '%(name)s-%(version)s_hpc2n_only_use_localhost.patch',
            ('hpc2n_slurm_hosts.template', '.'),
        ],
        'preconfigopts': "cp hpc2n_slurm_hosts.template pyworkflow/templates/hosts.template && ",
        'source_tmpl': 'V%(version)s.tar.gz',
        'source_urls': ['https://github.com/I2PC/scipion/archive/'],
        'checksums': [
            '73512d7f62b90cab81cc184f756e41267681ad24593ca6aeb831e7eff5c30600',  # V2.0.0.tar.gz
            # Scipion-2.0.0_use_mpi_java_from_EB.patch
            '25b0d3e5b34bafe60979b1a13e8e83eba61f38c4ba26a5c73611abe44369b75e',
            # Scipion-2.0.0_ignore_path_check_when_doing_config.patch
            'e79ec407442fcb8fa0df5066d4686e570678a7ef1768ac43d3f692dcf87dae9c',
            # Scipion-2.0.0_drop_packages_from_user_config.patch
            'ec22f8f46c0687a038904b0892ef7f489a81d50063a17c7718712985e52e5d5a',
            # Scipion-2.0.0_skip_notify_question.patch
            '34c41108be8cee63628bf0711191b10d7962f3d75bd2ecbae168776d67040b6d',
            # Scipion-2.0.0_hpc2n_only_use_localhost.patch
            'be99fb9a825f9bc61c5be8bcd0ab03674534b9b0ee84525446ef1a6dd6e56a96',
            # hpc2n_slurm_hosts.template
            '792785a89191233cfbe717e470bb4171c6b4af537a0fa4ba5344b76155deebb1',
        ],
    }),
    # Some of these reads scipion.conf so they must be after Scipion itself
    ('scipion-em-xmipp', '19.4.3', {
        'modulename': 'xmipp3',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['e00db2060707526ab59ddc2275bc38273c69eab0c904f6a040d09e633df94d52'],
    }),
    ('scipion-em-ctffind', '1.0.0', {
        'modulename': 'ctffind',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['a6dbc1ccc9e030c4b0a48f951a278910d23bf8f8416aacd5fb10fb716b398a2e'],
    }),
    ('scipion-em-relion', '1.0.7', {
        'modulename': 'relion',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['06becee63db18acc16ae2d22bac5f5c55e495922246f5aea10ffe4f47d40d9f7'],
    }),
    ('scipion-em-eman2', '1.0.5', {
        'modulename': 'eman2',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['98c2eb48fd8c6ffa1d4fdf281076e63591e4106074872bb18bd53abec3fbdfd6'],
    }),
    ('scipion-em-motioncorr', '1.0.4', {
        'modulename': 'motioncorr',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['a941a26dbd9e932301c451407a292ae20f627c81d5cdd56e7bb995b5e0f554f1'],
    }),
    ('scipion-em-gctf', '1.0.7', {
        'modulename': 'gctf',
        'source_tmpl': '%(name)s-%(version)s.tar.gz',
        'checksums': ['81057fc01068c57a7398affdb895f7f8045518eaf13eb9438d6dc66b6a3a5f4c'],
    }),
]

# Scipion uses TkAgg, make sure matplotlib uses that instead of its default Agg
modextravars = {'MPLBACKEND': 'TkAgg'}

moduleclass = 'bio'
